---
Title: AWS Backupの設定およびBackupジョブ失敗時の通知設定方法
Category:
- AWS
- Operations
Date: 2020-05-24T22:09:12+09:00
URL: https://kikuchi-et-al.hatenablog.jp/entry/2020/05/24/220912
EditURL: https://blog.hatena.ne.jp/kikuchi_et_al/kikuchi-et-al.hatenablog.jp/atom/entry/26006613573231472
---

# この記事は
今年の1月に[AWS Backupの機能がアップデートされ](https://aws.amazon.com/jp/about-aws/whats-new/2020/01/aws-backup-adds-support-amazon-elastic-cloud-compute-instance-backup/)、AMIも自動で取得できるようになりました。

この記事ではタイトルにも記載されている通り、AWS Backupの設定およびBackupジョブ失敗時の通知設定方法を紹介します。

また、手順にも記載されておりますがBackupジョブの通知先としてSNSを設定する際、現状CLIを使った操作が必ず必要になるので注意してください。

# ①. Backupジョブ失敗時の通知先となるSNSトピックを作成
## ①-1. SNSトピックを作成
[f:id:kikuchi_et_al:20200524215301p:plain]

## ①-2. JSONエディタを編集
**SNSのARN(2箇所あるので注意)** と **AWSアカウントID** の箇所は適宜置き換えること。
SNSのARNは `arn:aws:sns:リージョン名:AWSアカウントID:SNSトピック名`

```json
{
	"Version": "2008-10-17",
	"Id": "__default_policy_ID",
	"Statement": [
		{
			"Sid": "__default_statement_ID",
			"Effect": "Allow",
			"Principal": {
				"AWS": "*"
			},
			"Action": [
				"SNS:Publish",
				"SNS:RemovePermission",
				"SNS:SetTopicAttributes",
				"SNS:DeleteTopic",
				"SNS:ListSubscriptionsByTopic",
				"SNS:GetTopicAttributes",
				"SNS:Receive",
				"SNS:AddPermission",
				"SNS:Subscribe"
			],
			"Resource": "SNSのARN",
			"Condition": {
				"StringEquals": {
					"AWS:SourceOwner": "AWSアカウントID"
				}
			}
		},
		{
			"Sid": "__console_pub_0",
			"Effect": "Allow",
			"Principal": {
				"Service": "backup.amazonaws.com"
			},
			"Action": "SNS:Publish",
			"Resource": "SNSのARN"
		}
	]
}
```

# ②. バックアップボールトの作成
## ②-1. AWS Backupのコンソールへ移動

## ②-2. バックアップボールトを作成

[f:id:kikuchi_et_al:20200524215325p:plain]

---

[f:id:kikuchi_et_al:20200524215338p:plain]

## ②-3. AWS CLI を使用して、-backup-vault-events を BACKUP_JOB_COMPLETED に設定して put-backup-vault-notifications コマンドを実行

**<span style="color: #d61b09">現状、コンソール画面から設定する手段が無いため、CLIを使って操作する必要があります。</span>**

- endpoint-url: バックアップボールトがある AWS リージョンのエンドポイントを入力 ※東京リージョンなら `https://backup.ap-northeast-1.amazonaws.com`
- backup-vault-name: バックアップボールトの名前を入力
- sns-topic-arn: 作成した SNS トピックの ARN を入力

```
aws backup put-backup-vault-notifications --endpoint-url https://backup.eu-west-1.amazonaws.com --backup-vault-name examplevault --sns-topic-arn arn:aws:sns:eu-west-1:111111111111:exampletopic --backup-vault-events BACKUP_JOB_COMPLETED
```

[※公式ドキュメントから引用](https://aws.amazon.com/jp/premiumsupport/knowledge-center/aws-backup-failed-job-notification/)

##  ②-4. get-backup-vault-notifications コマンドを実行し、SNSの設定が反映されていることを確認
- backup-vault-name: バックアップボールトの名前を入力

```
aws backup get-backup-vault-notifications --backup-vault-name examplevault
```

以下のように出力されればOKです。

```json
{
    "BackupVaultName": "examplevault",
    "BackupVaultArn": "arn:aws:backup:eu-west-1:111111111111:backup-vault:examplevault",
    "SNSTopicArn": "arn:aws:sns:eu-west-1:111111111111:exampletopic",
    "BackupVaultEvents": [
        "BACKUP_JOB_COMPLETED"
    ]
}
```

[※公式ドキュメントから引用](https://aws.amazon.com/jp/premiumsupport/knowledge-center/aws-backup-failed-job-notification/)

# ③. サブスクリプションの作成

## ③-1. SNSのコンソールへ移動後、①で作成したSNSトピックをクリック

## ③-2. サブスクリプションの作成を押す

[f:id:kikuchi_et_al:20200524215359p:plain]

## ③-3. 詳細箇所を入力する
- トピック ARN：①で作成したSNSトピックを選択

プロトコル、エンドポイントは通知先に応じて適宜変更してください。
エンドポントにDatadogのWebhook URLを指定すると、Backupジョブの失敗通知をDatadogで受け取ることができます。

**■参考記事：[Datadog で AWS SNS を受け取る (RDS/ElastiCacheイベント)](https://cloudpack.media/40461)**

今回はメールで失敗通知の受信を行います。

## ③-4. サブスクリプションフィルターポリシーに下記を貼り付ける

```json
{
  "State": [
    {
      "anything-but": "COMPLETED"
    }
  ]
}
```

---

[f:id:kikuchi_et_al:20200524215418p:plain]

# ④. AWS Backupの構築
## ④-1. AWS Backupのコンソールへ移動

## ④-2. 「バックアッププランを作成」を押す
[f:id:kikuchi_et_al:20200524215431p:plain]

## ④-3. 「新しいプランを立てる」を押し、バックアッププラン名を入力
[f:id:kikuchi_et_al:20200524215447p:plain]

## ④-4. スケジュールを設定
下記設定で毎日、06:00 AM 〜 07:00 AM (JST) の間にAMI取得が開始される。

[f:id:kikuchi_et_al:20200524215512p:plain]

## ④-5. ライフサイクル設定
以下の設定でBackup世帯数が2になる。バックアップボールトには②で作成したものを選択すること。

[f:id:kikuchi_et_al:20200524215530p:plain]

## ④-6. 「リソースを割り当てる」を押す

[f:id:kikuchi_et_al:20200524215543p:plain]

## ④-7. リソースを割り当てる
今回はタグで管理してます。インスタンスIDを直接指定することも可能です。

[f:id:kikuchi_et_al:20200524215606p:plain]

## ④-8. Backupを取得したい対象リソースに対してタグを付ける

[f:id:kikuchi_et_al:20200524215622p:plain]

<b><span style="color: #d32f2f">これで設定は完了です。</span></b>

# ⑤. Backupジョブ失敗の通知テスト
[※公式ドキュメントから引用](https://aws.amazon.com/jp/premiumsupport/knowledge-center/aws-backup-failed-job-notification/)

## ⑤-1. 保護されたリソースからオンデマンドバックアップの作成を押す

[f:id:kikuchi_et_al:20200524215639p:plain]

## ⑤-2. 設定を行いオンデマンドバックアップを作成を押す
ここの設定画面で大事な箇所は以下の2点

- 今すぐバックアップを作成
- バックアップボールトを②で作成したものにする

[f:id:kikuchi_et_al:20200524215654p:plain]

## ⑤-3. バックアップジョブが実行されるのを確認

## ⑤-4. もう一度オンデマンドバックアップを作成を押す(設定もさっきと同じでOK)

[f:id:kikuchi_et_al:20200524215709p:plain]

## ⑤-5. 今度はバックアップジョブ IDをクリック

[f:id:kikuchi_et_al:20200524215724p:plain]

## ⑤-6. 停止を押す

[f:id:kikuchi_et_al:20200524215736p:plain]

## ⑤-7. ステータスが「中止しました」になることを確認

## ⑤-8. 停止したジョブの方のみ通知がきていることを確認
**ジョブを停止してから約8分後に通知が届きました。**

[f:id:kikuchi_et_al:20200524215754p:plain]

# おまけ

## AWS Backupで作成したAMIを削除するには

### バックアップボールトから②で作成したものを選択

[f:id:kikuchi_et_al:20200524220027p:plain]

### 作成したAMIを選択し削除を押す

[f:id:kikuchi_et_al:20200524220040p:plain]

## 実際にAMI Backupの取得に失敗した際に通知される内容

AMI Backupの取得が実際に失敗すると下記のように、 `An AWS Backup job failed.` というメッセージが通知されるようです。

```
An AWS Backup job failed. Resource ARN : arn:aws:ec2:*****:*****:instance/*****. BackupJob ID : *****
```
