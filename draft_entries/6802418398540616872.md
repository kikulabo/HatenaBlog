---
Title: MySQL のダブルライトバッファについて理解する
EditURL: https://blog.hatena.ne.jp/kikuchi_et_al/kikuchi-et-al.hatenablog.jp/atom/entry/6802418398540616872
PreviewURL: https://kikuchi-et-al.hatenablog.jp/draft/entry/mA7JpEKXaAgiHYgqWI-dQTWfYcE
---

# 概要

MySQL のダブルライトバッファについて学ぶ機会があったので備忘録としてまとめる。

## ダブルライトバッファとは

DB がページをディスクに書き込む際（ページクリーナーが動作する際）に、まずダブルライトバッファに書き込んでから IBD ファイルに書き込むことで、書き込み途中に MySQL が異常終了したとしても破損を防ぐ仕組み。

ダブルライトバッファはバッファという名前が付いているが、実際にはファイル上（ディスク上）に存在する。

## どういったケースを想定しているか

例えば 16 KB のページ（InnoDB のデフォルトページサイズ）のうち、最初の 4 KB を IBD ファイルに書き込めたが、残りの 12 KB の書き込みが完了する前に MySQL が異常終了した場合などを想定している。

この場合、残りの 12 KB の書き込みが完了していないため、IBD ファイルのページが破損してしまう可能性がある。

## ダブルライトバッファの仕組み

1. ページクリーナーが IBD ファイルを更新する際、まずダブルライトバッファに書き込む
2. ダブルライトバッファへの書き込みに成功した後に、IBD ファイルのページに書き込む

このように同じデータを 2 回書き込むからダブルライトバッファと呼ばれている。

## クラッシュリカバリ時の挙動

IBD ファイルのページとダブルライトバッファーのページのチェックサム値を比較することで、データの整合性を確認する。

- ダブルライトバッファにページがあり、チェックサムが IBD ファイルのものと一致する場合
  - ダブルライトバッファにあるページは正常に IBD ファイルのページに書き込まれている（フラッシュされている）ので問題なし
- ダブルライトバッファにページはあるが、チェックサムが IBD ファイルのものと一致しない場合
  - ダブルライトバッファにあるページが正常に IBD ファイルのページに書き込まれていないことになる
  - ダブルライトバッファには正常なページがあるので、ダブルライトバッファのページを IBD ファイルのページに書き込む
- ダブルライトバッファにページがない場合 or ダブルライトバッファにあるページが破損している場合
  - ダーティページが IBD ファイルに書き込まれていない（フラッシュされていない）状態
  - IBD ファイルと REDO ログを利用して復元する

