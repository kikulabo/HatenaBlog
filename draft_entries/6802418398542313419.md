---
Title: MySQL のチェンジバッファについて理解する
Date: 2025-08-11T23:20:32+09:00
Category:
- MySQL
- Database
- 備忘録
EditURL: https://blog.hatena.ne.jp/kikuchi_et_al/kikuchi-et-al.hatenablog.jp/atom/entry/6802418398542313419
PreviewURL: https://kikuchi-et-al.hatenablog.jp/draft/entry/MUqWrGxnCpuF69y2e4Ib7gQlFqc
---

# 概要

MySQL のチェンジバッファは MySQL 8.4 からデフォルトで無効になった機能だが、学ぶ機会があったので備忘録としてまとめる。

## チェンジバッファとは

チェンジバッファはセカンダリインデックスページがバッファプールに存在しない場合に、そのページへの変更を一時的にキャッシュし後でマージすることで更新を効率化する仕組み。

※ページとは InnoDB の最小の I/O 単位（通常16KB）

## なぜチェンジバッファが必要だったか

### 複数のインデックスを同時に更新するのはコストが高いため

テーブルに定義されている全てのインデックスをバッファプールに読み込んで更新するのは、セカンダリインデックスが多い場合は特にコストが高くなるため。

- 例
    - A: index(age, updated_at)
    - B: index(age, created_at)
    - C: index(age)
- 例えば age カラムに対して UPDATE を実行すると、A, B, C の全てのインデックスが更新される必要がある。
    - これらのインデックスがバッファプールに存在しない場合、全てのインデックスページをディスクから読み込む必要がある → I/O 負荷が高い

### セカンダリインデックスの更新が遅れるとデータの不整合が起きる可能性があるため

プライマリインデックスだけが更新され、セカンダリインデックスの更新が遅れた場合、データの矛盾が生じる可能性がある。

例えば、初期状態では 19 歳、20 歳、21 歳の 3 人がいた状態で全員の年齢を+1歳するクエリを実行したとする。

```sql
UPDATE users SET age = age + 1;
```

- 更新後の理想的な状態
    - クラスタインデックス（PK）：20歳、21歳、22歳（即座に更新）
    - セカンダリインデックス：20歳、21歳、22歳（本来あるべき姿）
- 実際
    - クラスタインデックス：20歳、21歳、22歳（即座に更新）
    - セカンダリインデックス：19歳、20歳、21歳（チェンジバッファで遅延中）

もし、セカンダリインデックスの更新が遅れた場合、20歳以上の平均年齢を求めるクエリを実行すると、データの不整合が発生する可能性がある。

```sql
SELECT AVG(age) FROM users WHERE age >= 20;
```

- クラスタインデックスを使った場合
    - 20歳、21歳、22歳が対象 → 平均21歳
- セカンダリインデックスを使った場合
    1. セカンダリインデックスで20歳、21歳を見つける（19歳は除外）
    2. 該当するID（2番、3番）を取得
    3. 2度引きでクラスタインデックスから実データを取得
    4. 実データは21歳、22歳 → 平均21.5歳 → 【結果が矛盾】

結果の矛盾が発生する理由としては、通常 MySQL はインデックス検索の2度引きを行う。

※インデックス検索の2度引き: セカンダリインデックスで条件に合う行を探して PK を取得し、その PK を使ってクラスタインデックスから最新データを取得する

しかし、セカンダリインデックス自体が古いと、WHERE 句の評価段階で本来含まれるべき行が除外されたり、含まれるべきでない行が含まれてしまう可能性がある。

そのため、どの行を取得するかの判断をセカンダリインデックスの古い値で行うと、結果が変わることがある。

## チェンジバッファの基本的な仕組み

- 条件
    - セカンダリインデックスページがバッファプールに存在しない場合にのみ使用される
- バッファリング
    - 変更内容をチェンジバッファに記録
- マージ
    - 後でそのインデックスページがバッファプールに読み込まれた際に、チェンジバッファの内容をマージ

例：5 ページのインデックスのうち 3 ページがバッファプールに載っている場合、残り 2 ページ分だけチェンジバッファが使用される。

## 最近ではチェンジバッファが利用されなくなってきた理由

チェンジバッファは主に HDD のランダムディスク I/O を削減するための機能だったが、現在の主流である SSD ではランダムディスク I/O とシーケンシャルディスク I/O の性能差が小さく、チェンジバッファを利用してもさほど性能が向上しないため利用されなくなってきた。
